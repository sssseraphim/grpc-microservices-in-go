name: "Execute Listing"

env:
  GITHUB_USERNAME: ${{ github.actor }}
  GITHUB_EMAIL: "${{ github.actor }}@users.noreply.github.com"

on:
  workflow_dispatch:
    inputs:
      listing:
        type: string
        description: 'Listing number (e.g. 2.1)'
        required: true

jobs:
  execute-listing:
    name: "Executing listing ${{ github.event.inputs.listing }}"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Go
        uses: actions/setup-go@v3
        with:
          go-version: "1.17"
          cache: true  # Enable caching automatically

      - name: Install Protoc Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Find and execute listing
        run: |
          # Find the directory (handle potential multiple matches)
          LISTING_DIR=$(find . -type d -name "listing_${{ github.event.inputs.listing }}" | head -1)
          
          if [ -z "$LISTING_DIR" ]; then
            echo "‚ùå Error: Directory 'listing_${{ github.event.inputs.listing }}' not found"
            exit 1
          fi
          
          echo "üìÅ Found directory: $LISTING_DIR"
          
          cd "$LISTING_DIR"
          
          # Make run.sh executable if it exists
          if [ -f "run.sh" ]; then
            chmod +x run.sh
            ./run.sh "$GITHUB_USERNAME" "$GITHUB_EMAIL"
          else
            echo "‚ùå Error: run.sh not found in $LISTING_DIR"
            exit 1
          fi
